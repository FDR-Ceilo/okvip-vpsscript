#!/bin/bash

# Kiểm tra quyền root
if [ "$EUID" -ne 0 ]; then
  echo "Vui lòng chạy với quyền root."
  exit 1
fi

# Kiểm tra phiên bản Ubuntu
OS=$(lsb_release -si)
VERSION=$(lsb_release -sr)

if [[ "$OS" != "Ubuntu" || "$VERSION" != "20.04" ]]; then
  echo "Script này chỉ hỗ trợ Ubuntu 20.04."
  exit 1
fi

# Đọc thông tin đầu vào
MYSQL_ROOT_PASSWORD=$1
DOMAIN=$2
WEB_ROOT="/var/www/$DOMAIN"
DB_NAME=$(echo "$DOMAIN" | cut -d '.' -f 1)
DB_USER=$DB_NAME"_user"
DB_PASSWORD=$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 12 | head -n 1)

if [ -z "$MYSQL_ROOT_PASSWORD" ] || [ -z "$DOMAIN" ]; then
  echo "Sử dụng: ./script.sh <mysql_root_password> <domain>"
  exit 1
fi

echo "Bắt đầu cài đặt WordPress với domain $DOMAIN..."

# Cập nhật và nâng cấp hệ thống
apt update && apt upgrade -y

# Cài đặt Nginx, MySQL, PHP và các phần phụ thuộc
apt install nginx mysql-server php-fpm php-mysql -y

# Cấu hình MySQL
echo "Đặt mật khẩu cho MySQL root..."
sudo mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED BY '$MYSQL_ROOT_PASSWORD';"

# Tạo cơ sở dữ liệu và người dùng MySQL
echo "Tạo database và user cho WordPress..."
mysql -uroot -p"$MYSQL_ROOT_PASSWORD" -e "CREATE DATABASE $DB_NAME;"
mysql -uroot -p"$MYSQL_ROOT_PASSWORD" -e "CREATE USER '$DB_USER'@'localhost' IDENTIFIED BY '$DB_PASSWORD';"
mysql -uroot -p"$MYSQL_ROOT_PASSWORD" -e "GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'localhost';"
mysql -uroot -p"$MYSQL_ROOT_PASSWORD" -e "FLUSH PRIVILEGES;"

# Cài đặt WP-CLI
echo "Cài đặt WP-CLI..."
curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
chmod +x wp-cli.phar
mv wp-cli.phar /usr/local/bin/wp

# Tạo thư mục cho website và cấu hình Nginx
echo "Cấu hình Nginx cho website $DOMAIN..."
mkdir -p $WEB_ROOT
cat > /etc/nginx/sites-available/$DOMAIN <<EOL
server {
    listen 80;
    server_name $DOMAIN;
    root $WEB_ROOT;

    index index.php index.html index.htm;

    location / {
        try_files \$uri \$uri/ /index.php?\$args;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
        fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~ /\.ht {
        deny all;
    }

    error_log /var/log/nginx/$DOMAIN-error.log;
    access_log /var/log/nginx/$DOMAIN-access.log;
}
EOL

# Kích hoạt cấu hình Nginx
ln -s /etc/nginx/sites-available/$DOMAIN /etc/nginx/sites-enabled/
nginx -t
systemctl restart nginx

# Thêm domain vào /etc/hosts
echo "127.0.0.1 $DOMAIN" >> /etc/hosts

# Tải và cài đặt WordPress
echo "Tải và cài đặt WordPress..."
cd $WEB_ROOT
wp core download --allow-root

# Tạo file wp-config.php với WP-CLI và thiết lập secret keys
echo "Cấu hình wp-config.php..."
wp config create --dbname="$DB_NAME" --dbuser="$DB_USER" --dbpass="$DB_PASSWORD" --dbhost="localhost" --allow-root
wp config shuffle-salts --allow-root

# Thiết lập quyền cho thư mục website
chown -R www-data:www-data $WEB_ROOT
chmod -R 755 $WEB_ROOT

# Cài đặt WordPress qua WP-CLI
echo "Cài đặt WordPress..."
wp core install --url="http://$DOMAIN" --title="WordPress Site" --admin_user="admin" --admin_password="admin_password" --admin_email="admin@$DOMAIN" --allow-root

# Kết thúc
echo "WordPress đã được cài đặt thành công trên domain http://$DOMAIN!"
echo "Thông tin cơ sở dữ liệu:"
echo "  - Database: $DB_NAME"
echo "  - User: $DB_USER"
echo "  - Password: $DB_PASSWORD"
