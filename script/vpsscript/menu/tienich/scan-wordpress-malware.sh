#!/bin/bash

# Kiểm tra nếu không phải root thì thoát
if [ "$EUID" -ne 0 ]; then
  echo "Error: Vui lòng chạy script với quyền root."
  exit 1
fi

# Đặt thư mục đích
TARGET_DIR="/etc/vpsscript/menu/tienich"

# Kiểm tra thư mục đích
if [ ! -d "$TARGET_DIR" ]; then
  echo "Creating directory $TARGET_DIR"
  mkdir -p "$TARGET_DIR"
  chmod 755 "$TARGET_DIR"
  chown -R root:root "$TARGET_DIR"
fi

# Chuyển đến thư mục đích
cd "$TARGET_DIR" || {
  echo "Error: Không thể chuyển đến thư mục $TARGET_DIR"
  exit 1
}

# Kiểm tra nếu curl đã được cài đặt
if ! command -v curl &>/dev/null; then
  echo "Error: curl chưa được cài đặt. Vui lòng cài curl."
  exit 1
fi

# Tải file từ GitHub
echo "Downloading files..."
curl -sO https://raw.githubusercontent.com/raymonditweb/okvip-vpsscript/master/script/vpsscript/menu/tienich/scan-wordpress-malware-action.sh || {
  echo "Error: Failed to download scan-wordpress-malware-action.sh"
  exit 1
}
curl -sO https://raw.githubusercontent.com/raymonditweb/okvip-vpsscript/master/templates/wordpress/.htaccess || {
  echo "Error: Failed to download .htaccess"
  exit 1
}

# Kiểm tra sự tồn tại của file sau khi tải
SCRIPT_FILE="$TARGET_DIR/scan-wordpress-malware-action.sh"
if [ ! -f "$SCRIPT_FILE" ]; then
  echo "Error: File không thấy! $SCRIPT_FILE"
  exit 1
fi

# Cấp quyền thực thi cho script
echo "Cấp quyền thực thi cho $SCRIPT_FILE"
chmod +x "$SCRIPT_FILE"

# Xóa khoảng trắng đầu và cuối dòng, các dòng trống, và ký tự carriage return
echo "Xóa dư thừa..."
sed -i -e 's/^[ \t]*//' -e 's/ *$//' -e '/^$/d' -e 's/\r//' "$SCRIPT_FILE"

# Thực thi script
echo "Executing $SCRIPT_FILE"
bash "$SCRIPT_FILE"
