#!/bin/bash

# Kiểm tra quyền root
if [ "$EUID" -ne 0 ]; then
  echo "Error: Vui lòng chạy với quyền root."
  exit 1
fi

# Đọc thông tin đầu vào
DOMAIN=$1
NGINX_CONFIG="/etc/nginx/sites-available/$DOMAIN"
NGINX_CONFIG_SYMLINK="/etc/nginx/sites-enabled/$DOMAIN"

if [ -z "$DOMAIN" ]; then
  echo "Error: Sử dụng: ./disable-website.sh <domain>"
  exit 1
fi

# Kiểm tra symlink trong sites-enabled
if [ ! -f "$NGINX_CONFIG_SYMLINK" ]; then
  echo "Website $DOMAIN chưa được bật hoặc không có trong sites-enabled."
else
  echo "Tắt website $DOMAIN..."
  
  # Thêm cấu hình để chặn tất cả kết nối vào HTTP và HTTPS
  echo "Thêm cấu hình vào $NGINX_CONFIG để chặn tất cả các domain..."
  sed -i '1s/^/server {\n    listen 80;\n    listen 443 ssl;\n    server_name _;\n    return 444;\n}/' "$NGINX_CONFIG"

  # Xóa symlink trong sites-enabled
  rm -f "$NGINX_CONFIG_SYMLINK"
fi

# Tải lại Nginx
echo "Tải lại Nginx..."
nginx -t && systemctl reload nginx

echo "Website $DOMAIN đã được tắt!"
