#!/bin/bash

# Kiểm tra quyền root
if [ "$EUID" -ne 0 ]; then
  echo "Error: Vui lòng chạy với quyền root."
  exit 1
fi

# Đọc thông tin đầu vào
DOMAIN=$1
NGINX_CONFIG_SYMLINK="/etc/nginx/sites-enabled/$DOMAIN"
NGINX_CONFIG_AVAILABLE="/etc/nginx/sites-available/$DOMAIN"

if [ -z "$DOMAIN" ]; then
  echo "Error: Sử dụng: ./disable-website.sh <domain>"
  exit 1
fi

# Kiểm tra symlink trong sites-enabled
if [ -L "$NGINX_CONFIG_SYMLINK" ]; then
  echo "Tắt website $DOMAIN..."
  rm -f "$NGINX_CONFIG_SYMLINK"
else
  echo "Website $DOMAIN chưa được bật hoặc không có trong sites-enabled."
fi

# Chèn cấu hình return 444 vào sites-available
if [ -f "$NGINX_CONFIG_AVAILABLE" ]; then
  echo "Cập nhật cấu hình để chặn truy cập vào $DOMAIN..."

  # Thêm một server block mới nếu chưa tồn tại
  if ! grep -q "server.*return 444;" "$NGINX_CONFIG_AVAILABLE"; then
    echo -e "\n# Block access to the domain\nserver {\n    server_name $DOMAIN;\n    return 444;\n}" >> "$NGINX_CONFIG_AVAILABLE"
  else
    echo "Cấu hình chặn truy cập đã tồn tại trong $NGINX_CONFIG_AVAILABLE."
  fi
else
  echo "Error: Không tìm thấy tệp cấu hình trong /etc/nginx/sites-available/."
  exit 1
fi

# Tải lại Nginx
echo "Tải lại Nginx..."
if nginx -t; then
  systemctl reload nginx
  echo "Website $DOMAIN đã được tắt và chặn truy cập!"
else
  echo "Error: Cấu hình Nginx không hợp lệ. Kiểm tra lại tệp cấu hình!"
  exit 1
fi
