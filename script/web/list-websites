#!/bin/bash

# Kiểm tra xem người dùng có quyền root hay không
if [ "$EUID" -ne 0 ]; then
  echo "Error: Vui lòng chạy script với quyền root."
  exit 1
fi

# Kiểm tra xem Nginx hoặc Apache đã được cài đặt hay chưa
if command -v nginx &>/dev/null; then
  WEBSERVER="nginx"
  CONF_PATH="/etc/nginx/sites-available"
elif command -v apache2 &>/dev/null; then
  WEBSERVER="apache"
  CONF_PATH="/etc/apache2/sites-available"
else
  echo "Không tìm thấy Nginx hoặc Apache trên hệ thống. Đang tiến hành cài đặt Nginx..."

  # Xác định hệ điều hành và cài đặt Nginx
  if [ -f /etc/debian_version ]; then
    # Debian/Ubuntu
    apt update
    apt install -y nginx
  elif [ -f /etc/redhat-release ]; then
    # CentOS/RHEL
    yum install -y nginx
  else
    echo "Error: Hệ điều hành không được hỗ trợ."
    exit 1
  fi

  # Kiểm tra lại Nginx sau khi cài đặt
  if command -v nginx &>/dev/null; then
    WEBSERVER="nginx"
    CONF_PATH="/etc/nginx/sites-available"
    echo "Nginx đã được cài đặt thành công."
  else
    echo "Error: Cài đặt Nginx thất bại."
    exit 1
  fi
fi

echo "Liệt kê danh sách website trên $WEBSERVER:"

# Biến cờ để theo dõi số lượng website
FOUND_WEBSITES=0

# Liệt kê các file cấu hình trong thư mục cấu hình
if [ -d "$CONF_PATH" ]; then
  for CONF_FILE in "$CONF_PATH"/*; do
    if [ -f "$CONF_FILE" ]; then
      # Đọc danh sách domain từ file cấu hình
      if [ "$WEBSERVER" = "nginx" ]; then
        DOMAINS=$(grep -E "server_name" "$CONF_FILE" | awk '{for (i=2; i<=NF; i++) print $i}' | sed 's/;$//' | grep -Ev "^_|^localhost$|^server_name$")
      elif [ "$WEBSERVER" = "apache" ]; then
        DOMAINS=$(grep -E "ServerName|ServerAlias" "$CONF_FILE" | awk '{for (i=2; i<=NF; i++) print $i}' | sed 's/;$//')
      fi

      # Hiển thị từng domain nếu tìm thấy
      if [ -n "$DOMAINS" ]; then
        for DOMAIN in $DOMAINS; do
          echo "- $DOMAIN"
          FOUND_WEBSITES=1
        done
      fi
    fi
  done

  # Kiểm tra nếu không tìm thấy website nào
  if [ "$FOUND_WEBSITES" -eq 0 ]; then
    echo "Không tìm thấy website nào."
  fi
else
  echo "Error: Không tìm thấy thư mục cấu hình $CONF_PATH."
  exit 1
fi
