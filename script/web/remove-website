#!/bin/bash

LOG_FILE="/var/log/remove-website.log"

log() {
  echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

# Kiểm tra quyền root
if [ "$EUID" -ne 0 ]; then
  log "Error: Vui lòng chạy với quyền root."
  exit 1
fi

# Đọc thông tin đầu vào
DOMAIN=$1
MYSQL_ROOT_PASSWORD=$2

if [ -z "$DOMAIN" ] || [ -z "$MYSQL_ROOT_PASSWORD" ]; then
  log "Error: Sử dụng: <domain> <mysql_root_password>"
  exit 1
fi

DB_NAME="${DOMAIN//./_}" # Tên cơ sở dữ liệu, thay thế dấu chấm bằng dấu gạch dưới
DB_USER="${DB_NAME}_user"
WEB_ROOT="/var/www/$DOMAIN"
BACKUP_DIR="/backup/$DOMAIN"

log "Bắt đầu quá trình xóa website cho domain: $DOMAIN"

# Tạo thư mục sao lưu tam thoi
mkdir -p "$BACKUP_DIR" && log "Đã tạo thư mục sao lưu tam thoi: $BACKUP_DIR"

# Sao lưu cấu hình Nginx
if [ -f "/etc/nginx/sites-available/$DOMAIN" ]; then
  cp "/etc/nginx/sites-available/$DOMAIN" "$BACKUP_DIR/"
  log "Đã sao lưu cấu hình Nginx."
fi

# Sao lưu thư mục web
if [ -d "$WEB_ROOT" ]; then
  tar -czf "$BACKUP_DIR/webroot.tar.gz" "$WEB_ROOT"
  log "Đã sao lưu thư mục web tại $BACKUP_DIR/webroot.tar.gz."
fi

# Sao lưu database
if mysql -uroot -p"$MYSQL_ROOT_PASSWORD" -e "SHOW DATABASES LIKE '$DB_NAME';" | grep -q "$DB_NAME"; then
  mysqldump -uroot -p"$MYSQL_ROOT_PASSWORD" "$DB_NAME" >"$BACKUP_DIR/$DB_NAME.sql" &&
    log "Đã sao lưu database tại $BACKUP_DIR/$DB_NAME.sql." || {
    log "Error: Không thể sao lưu database."
    exit 1
  }
else
  log "Database không tồn tại hoặc không thể truy cập."
fi

# Xóa dữ liệu
DELETE_SUCCESS=true

# Xóa cấu hình Nginx
if [ -f "/etc/nginx/sites-available/$DOMAIN" ]; then
  rm "/etc/nginx/sites-available/$DOMAIN" || DELETE_SUCCESS=false
fi
if [ -L "/etc/nginx/sites-enabled/$DOMAIN" ]; then
  rm "/etc/nginx/sites-enabled/$DOMAIN" || DELETE_SUCCESS=false
fi

# Xóa database và user MySQL
if mysql -uroot -p"$MYSQL_ROOT_PASSWORD" -e "SHOW DATABASES LIKE '$DB_NAME';" | grep -q "$DB_NAME"; then
  mysql -uroot -p"$MYSQL_ROOT_PASSWORD" -e "DROP DATABASE $DB_NAME;" || DELETE_SUCCESS=false
fi
if mysql -uroot -p"$MYSQL_ROOT_PASSWORD" -e "SELECT User FROM mysql.user WHERE User = '$DB_USER';" | grep -q "$DB_USER"; then
  mysql -uroot -p"$MYSQL_ROOT_PASSWORD" -e "DROP USER IF EXISTS '$DB_USER'@'localhost';" || DELETE_SUCCESS=false
  mysql -uroot -p"$MYSQL_ROOT_PASSWORD" -e "DROP USER IF EXISTS '$DB_USER'@'%';" || DELETE_SUCCESS=false
fi

# Xóa thư mục web
if [ -d "$WEB_ROOT" ]; then
  rm -rf "$WEB_ROOT" || DELETE_SUCCESS=false
fi

# Xử lý kết quả xóa
if [ "$DELETE_SUCCESS" = true ]; then
  log "Đã xóa dữ liệu thành công."
else
  log "Xóa dữ liệu không thành công. Đang khôi phục từ bản sao lưu..."

  # Khôi phục cấu hình Nginx
  if [ -f "$BACKUP_DIR/$DOMAIN" ]; then
    cp "$BACKUP_DIR/$DOMAIN" "/etc/nginx/sites-available/$DOMAIN"
    ln -s "/etc/nginx/sites-available/$DOMAIN" "/etc/nginx/sites-enabled/$DOMAIN"
    log "Đã khôi phục cấu hình Nginx."
  fi

  # Khôi phục thư mục web
  if [ -f "$BACKUP_DIR/webroot.tar.gz" ]; then
    tar -xzf "$BACKUP_DIR/webroot.tar.gz" -C "/var/www/"
    log "Đã khôi phục thư mục web."
  fi

  # Khôi phục database
  if [ -f "$BACKUP_DIR/$DB_NAME.sql" ]; then
    mysql -uroot -p"$MYSQL_ROOT_PASSWORD" -e "CREATE DATABASE $DB_NAME;"
    mysql -uroot -p"$MYSQL_ROOT_PASSWORD" "$DB_NAME" <"$BACKUP_DIR/$DB_NAME.sql"
    log "Đã khôi phục database MySQL."
  fi

  log "Khôi phục dữ liệu hoàn tất."
  exit 1
fi

# Xóa backup sau khi thành công
if [ -d "$BACKUP_DIR" ]; then
  rm -rf "$BACKUP_DIR" && log "Đã xóa thư mục sao lưu tam thoi để tiết kiệm dung lượng." || {
    log "Warning: Không thể xóa thư mục sao lưu tam thoi tại $BACKUP_DIR."
  }
fi

log "Quá trình xóa website hoàn tất."
