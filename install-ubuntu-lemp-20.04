#!/bin/bash

# Kiểm tra quyền root
if [ "$EUID" -ne 0 ]; then
  echo "Vui lòng chạy với quyền root."
  exit 1
fi

# Kiểm tra xem script đã được cài trước đó chưa
if [ -f "/home/vpsscript.conf" ]; then
  echo "Script đã được cài trên VPS này. Xem thông tin trong /home/vpsscript.conf"
  exit 0
fi

# Kiểm tra phiên bản Ubuntu
OS=$(lsb_release -si)
VERSION=$(lsb_release -sr)

if [[ "$OS" != "Ubuntu" || "$VERSION" != "20.04" ]]; then
  echo "Script này chỉ hỗ trợ Ubuntu 20.04."
  exit 1
fi

# Đọc mật khẩu MySQL từ tham số dòng lệnh hoặc tạo ngẫu nhiên nếu không có
MYSQL_ROOT_PASSWORD=$1

if [ -z "$MYSQL_ROOT_PASSWORD" ]; then
  # Tạo mật khẩu ngẫu nhiên nếu không được truyền vào
  MYSQL_ROOT_PASSWORD=$(openssl rand -base64 12)
 
fi

# Đọc domain từ tham số dòng lệnh hoặc dùng mặc định
DOMAIN=${2:-"vpsscript.demo"}
WEB_ROOT="/var/www/$DOMAIN"
DB_NAME=$(echo "$DOMAIN" | cut -d '.' -f 1)

echo "Bắt đầu cài đặt LEMP stack trên Ubuntu 20.04 với domain $DOMAIN..."

# Cập nhật và nâng cấp hệ thống
apt update && apt upgrade -y

# Cài đặt Nginx
echo "Cài đặt Nginx..."
apt install nginx -y

# Mở full cổng firewall cho Nginx
ufw allow 'Nginx Full'

# Lấy phiên bản Nginx
NGINX_VERSION=$(nginx -v 2>&1 | cut -d '/' -f 2)

# Cài đặt MySQL 5.7
echo "Cài đặt MySQL 5.7..."
wget https://dev.mysql.com/get/mysql-apt-config_0.8.12-1_all.deb
dpkg -i mysql-apt-config_0.8.12-1_all.deb
apt update
apt install mysql-server -y

# Thiết lập MySQL với mật khẩu root truyền từ dòng lệnh hoặc đã tạo
echo "Thiết lập bảo mật MySQL..."
mysql --user=root <<-EOF
  ALTER USER 'root'@'localhost' IDENTIFIED WITH 'mysql_native_password' BY '$MYSQL_ROOT_PASSWORD';
  FLUSH PRIVILEGES;
EOF

mysql_secure_installation <<EOF

y
$MYSQL_ROOT_PASSWORD
$MYSQL_ROOT_PASSWORD
y
y
y
y
EOF

# Tạo database với tên từ domain không có phần mở rộng
echo "Tạo database có tên $DB_NAME..."
mysql --user=root --password="$MYSQL_ROOT_PASSWORD" -e "CREATE DATABASE $DB_NAME CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

# Cài đặt PHP 7.4 và các module cần thiết
echo "Cài đặt PHP 7.4..."
apt install php7.4-fpm php7.4-mysql php7.4-cli php7.4-curl php7.4-json php7.4-mbstring php7.4-xml php7.4-zip php7.4-gd -y

# Lấy phiên bản PHP
PHP_VERSION=$(php -v | head -n 1 | cut -d ' ' -f 2)

# Cài đặt phpMyAdmin
echo "Cài đặt phpMyAdmin..."
DEBIAN_FRONTEND=noninteractive apt install phpmyadmin -y

# Lấy phiên bản phpMyAdmin
PHPMYADMIN_VERSION=$(dpkg -l | grep phpmyadmin | awk '{print $3}')

# Cấu hình phpMyAdmin với Nginx và mở cổng
PHPMYADMIN_PORT=8080
ln -s /usr/share/phpmyadmin /var/www/html/phpmyadmin

# Mở cổng cho phpMyAdmin
ufw allow $PHPMYADMIN_PORT

# Khởi động lại các dịch vụ
systemctl restart nginx
systemctl restart mysql
systemctl restart php7.4-fpm

# Tạo một site demo với domain truyền vào hoặc mặc định vpsscript.demo
echo "Tạo site mẫu $DOMAIN..."

# Tạo thư mục cho website
mkdir -p $WEB_ROOT

# Tạo một trang index.php mẫu
echo "<?php phpinfo(); ?>" > $WEB_ROOT/index.php

# Chuyển quyền thư mục
chown -R www-data:www-data $WEB_ROOT
chmod -R 755 $WEB_ROOT

# Cấu hình Nginx cho website
cat > /etc/nginx/sites-available/$DOMAIN <<EOL
server {
    listen 80;
    server_name $DOMAIN;
    root $WEB_ROOT;

    index index.php index.html index.htm;

    location / {
        try_files \$uri \$uri/ =404;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
        fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~ /\.ht {
        deny all;
    }

    error_log /var/log/nginx/$DOMAIN-error.log;
    access_log /var/log/nginx/$DOMAIN-access.log;
}
EOL

# Kích hoạt cấu hình website
ln -s /etc/nginx/sites-available/$DOMAIN /etc/nginx/sites-enabled/

# Kiểm tra cấu hình Nginx
nginx -t

# Khởi động lại Nginx để áp dụng cấu hình mới
systemctl restart nginx

# Thêm domain vào /etc/hosts
echo "127.0.0.1 $DOMAIN" >> /etc/hosts

# Lấy địa chỉ IP server
SERVER_IP=$(hostname -I | awk '{print $1}')

# Ghi thông tin cấu hình ra file vpsscript.conf
cat > "/home/vpsscript.conf" <<END
serverip="$SERVER_IP"
current_os_version="$VERSION"
nginx_version="$NGINX_VERSION"
php_version="$PHP_VERSION"
mainsite="$DOMAIN"
mysqlrootpass="$MYSQL_ROOT_PASSWORD"
phpmyadmin_version="$PHPMYADMIN_VERSION"
priport="$PHPMYADMIN_PORT"
END

echo "Thông tin cài đặt đã được lưu trong /home/vpsscript.conf"
echo "Website demo đã được khởi tạo thành công tại http://$DOMAIN!"
echo "Database $DB_NAME đã được tạo!"
echo "Bạn có thể truy cập phpMyAdmin tại http://$SERVER_IP:$PHPMYADMIN_PORT/phpmyadmin"
echo "Mật khẩu root: $MYSQL_ROOT_PASSWORD"
